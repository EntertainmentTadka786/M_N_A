<?php
/**
 * Telegram Request Bot with JSON Storage (Webhook Version)
 * 
 * Environment Variables (set on Render):
 * - BOT_TOKEN: Telegram bot token
 * - OWNER_ID: Telegram user ID of owner/admin
 * - REQUEST_GROUP_ID: Group ID where users send requests (numeric, can be negative)
 * - CHANNEL_IDS: Comma-separated list of channel IDs (e.g., "-100123,-100456")
 * - BOT_USERNAME: (optional) Bot username
 * 
 * Features:
 * - Hinglish messages
 * - Typing indicators
 * - Progress simulation with percentage
 * - JSON file storage (users.json)
 * - /start, /help, /uploads (paginated with Previous/Next)
 * - /import command to add existing channel files to database
 * - Error handling and logging
 * - Clean UI with inline keyboards
 */

// --- Configuration from environment ---
$botToken = getenv('BOT_TOKEN') ?: die('âŒ BOT_TOKEN environment variable not set.');
$ownerId = getenv('OWNER_ID') ?: die('âŒ OWNER_ID environment variable not set.');
$requestGroupId = getenv('REQUEST_GROUP_ID') ?: die('âŒ REQUEST_GROUP_ID environment variable not set.');
$channelIdsRaw = getenv('CHANNEL_IDS') ?: '';
$channelIds = array_filter(array_map('trim', explode(',', $channelIdsRaw)));

// Files for data and logs
define('USERS_FILE', __DIR__ . '/users.json');
define('LOG_FILE', __DIR__ . '/bot.log');

// --- Logging function ---
function logMessage($msg) {
    file_put_contents(LOG_FILE, date('[Y-m-d H:i:s] ') . $msg . PHP_EOL, FILE_APPEND);
}

// --- JSON storage functions ---
function loadUploads() {
    if (!file_exists(USERS_FILE)) {
        return [];
    }
    $content = file_get_contents(USERS_FILE);
    $data = json_decode($content, true);
    return is_array($data) ? $data : [];
}

function saveUploads($uploads) {
    file_put_contents(USERS_FILE, json_encode($uploads, JSON_PRETTY_PRINT));
    // Ensure permissions (in case file was created)
    chmod(USERS_FILE, 0664);
}

function addUploadRecord($fileName, $fileSize, $requesterId, $requesterName) {
    $uploads = loadUploads();
    $newId = count($uploads) > 0 ? max(array_column($uploads, 'id')) + 1 : 1;
    $uploads[] = [
        'id' => $newId,
        'file_name' => $fileName,
        'file_size' => $fileSize,
        'requester_id' => $requesterId,
        'requester_name' => $requesterName,
        'date' => time()
    ];
    saveUploads($uploads);
    return $newId;
}

function getUploadsCount() {
    return count(loadUploads());
}

function getUploadsPage($page, $perPage = 5) {
    $uploads = loadUploads();
    // Sort by date descending (newest first)
    usort($uploads, function($a, $b) {
        return $b['date'] - $a['date'];
    });
    $offset = ($page - 1) * $perPage;
    return array_slice($uploads, $offset, $perPage);
}

// --- Telegram API helper ---
function apiRequest($method, $data = []) {
    global $botToken;
    $url = "https://api.telegram.org/bot$botToken/$method";
    $options = [
        'http' => [
            'header'  => "Content-type: application/x-www-form-urlencoded\r\n",
            'method'  => 'POST',
            'content' => http_build_query($data),
        ],
    ];
    $context = stream_context_create($options);
    $result = @file_get_contents($url, false, $context);
    if ($result === FALSE) {
        logMessage("API call failed: $method");
        return null;
    }
    return json_decode($result, true);
}

function sendMessage($chatId, $text, $parseMode = 'HTML', $replyMarkup = null) {
    $data = [
        'chat_id' => $chatId,
        'text' => $text,
        'parse_mode' => $parseMode,
    ];
    if ($replyMarkup) {
        $data['reply_markup'] = json_encode($replyMarkup);
    }
    return apiRequest('sendMessage', $data);
}

function editMessageText($chatId, $messageId, $text, $parseMode = 'HTML', $replyMarkup = null) {
    $data = [
        'chat_id' => $chatId,
        'message_id' => $messageId,
        'text' => $text,
        'parse_mode' => $parseMode,
    ];
    if ($replyMarkup) {
        $data['reply_markup'] = json_encode($replyMarkup);
    }
    return apiRequest('editMessageText', $data);
}

function sendChatAction($chatId, $action = 'typing') {
    return apiRequest('sendChatAction', ['chat_id' => $chatId, 'action' => $action]);
}

function answerCallbackQuery($callbackQueryId, $text = null, $showAlert = false) {
    $data = ['callback_query_id' => $callbackQueryId];
    if ($text) $data['text'] = $text;
    if ($showAlert) $data['show_alert'] = true;
    return apiRequest('answerCallbackQuery', $data);
}

// --- Simulated progress (edits a single message) ---
function simulateProgress($chatId, $messageId) {
    $steps = [
        0  => "â³ Shuru ho raha hai... 0% [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]",
        25 => "ğŸ“¤ Uploading... 25% [â–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘â–‘â–‘]",
        50 => "ğŸ“¤ Uploading... 50% [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘]",
        75 => "ğŸ“¤ Uploading... 75% [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘]",
        100 => "âœ… Upload complete! 100% [â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ]"
    ];
    foreach ($steps as $percent => $text) {
        usleep(500000); // 0.5 seconds
        editMessageText($chatId, $messageId, $text);
    }
}

// --- Process incoming update ---
$content = file_get_contents('php://input');
$update = json_decode($content, true);

if (!$update) {
    if ($_SERVER['REQUEST_METHOD'] === 'GET') {
        echo "<h2>ğŸ¤– Bot is running!</h2>";
        echo "<p>Language: Hinglish | Storage: JSON</p>";
        echo "<p>Commands: /start, /help, /uploads, /import</p>";
        exit;
    }
    exit;
}

logMessage("Update received: " . json_encode($update));

// --- Handle callback queries (inline keyboard interactions) ---
if (isset($update['callback_query'])) {
    $cb = $update['callback_query'];
    $userId = $cb['from']['id'];
    $message = $cb['message'];
    $chatId = $message['chat']['id'];
    $messageId = $message['message_id'];
    $data = $cb['data'];

    // Only owner can interact with uploads list
    if ($userId != $ownerId) {
        answerCallbackQuery($cb['id'], "Sirf owner ke liye ğŸ™", true);
        exit;
    }

    // Pagination handling
    if (strpos($data, 'uploads_page_') === 0) {
        $page = (int)substr($data, strlen('uploads_page_'));
        $total = getUploadsCount();
        $perPage = 5;
        $maxPage = ceil($total / $perPage);
        if ($page < 1) $page = 1;
        if ($page > $maxPage) $page = $maxPage;

        $uploads = getUploadsPage($page, $perPage);
        $text = "ğŸ“ **Total Uploads:** $total\n\n";
        foreach ($uploads as $rec) {
            $date = date('d M Y', $rec['date']);
            $size = round($rec['file_size'] / 1024 / 1024, 2) . ' MB';
            $text .= "ğŸ†” #{$rec['id']}: {$rec['file_name']} ($size)\nğŸ‘¤ Requested by: {$rec['requester_name']}\nğŸ“… $date\n\n";
        }

        // Build inline keyboard
        $keyboard = [];
        $row = [];
        if ($page > 1) {
            $row[] = ['text' => 'â—€ï¸ Previous', 'callback_data' => 'uploads_page_' . ($page - 1)];
        }
        $row[] = ['text' => "ğŸ“„ $page / $maxPage", 'callback_data' => 'noop'];
        if ($page < $maxPage) {
            $row[] = ['text' => 'Next â–¶ï¸', 'callback_data' => 'uploads_page_' . ($page + 1)];
        }
        $keyboard[] = $row;

        editMessageText($chatId, $messageId, $text, 'Markdown', ['inline_keyboard' => $keyboard]);
        answerCallbackQuery($cb['id']);
    } elseif ($data === 'noop') {
        answerCallbackQuery($cb['id']); // Do nothing but acknowledge
    }
    exit;
}

// --- Handle regular messages ---
if (isset($update['message'])) {
    $message = $update['message'];
    $chatId = $message['chat']['id'];
    $userId = $message['from']['id'];
    $text = trim($message['text'] ?? '');

    sendChatAction($chatId, 'typing');

    // --- Private chat with owner ---
    if ($chatId == $userId) {
        if ($userId != $ownerId) {
            sendMessage($chatId, "âŒ Sirf owner interact kar sakte hain.");
            exit;
        }

        if ($text === '/start') {
            $msg = "ğŸ‘‹ Namaste Owner ji!\n\n";
            $msg .= "Main aapka request bot hoon (JSON version). Kuch bhi poochna ho to /help dabaye.";
            sendMessage($chatId, $msg);
        } elseif ($text === '/help') {
            $msg = "ğŸ†˜ **Help Menu**\n\n";
            $msg .= "â€¢ Request group mein jo bhi message karega, main aapko notify kar dunga.\n";
            $msg .= "â€¢ Kisi request ka reply mein file (document/video) bhej kar use sabhi channels mein post kar sakte ho.\n";
            $msg .= "â€¢ /uploads - Saari uploaded files dekho (paginated).\n";
            $msg .= "â€¢ /import - Kisi bhi existing channel post (jisme file ho) ko forward karke is command se database mein add kar sakte ho.\n";
            $msg .= "â€¢ Language: Hinglish ğŸ˜‰";
            sendMessage($chatId, $msg, 'Markdown');
        } elseif ($text === '/uploads') {
            $total = getUploadsCount();
            if ($total == 0) {
                sendMessage($chatId, "ğŸ“‚ Abhi tak koi upload nahi hui.");
                exit;
            }

            $perPage = 5;
            $page = 1;
            $maxPage = ceil($total / $perPage);
            $uploads = getUploadsPage($page, $perPage);

            $text = "ğŸ“ **Total Uploads:** $total\n\n";
            foreach ($uploads as $rec) {
                $date = date('d M Y', $rec['date']);
                $size = round($rec['file_size'] / 1024 / 1024, 2) . ' MB';
                $text .= "ğŸ†” #{$rec['id']}: {$rec['file_name']} ($size)\nğŸ‘¤ Requested by: {$rec['requester_name']}\nğŸ“… $date\n\n";
            }

            $keyboard = [];
            $row = [];
            if ($page < $maxPage) {
                $row[] = ['text' => 'Next â–¶ï¸', 'callback_data' => 'uploads_page_' . ($page + 1)];
            }
            $row[] = ['text' => "ğŸ“„ $page / $maxPage", 'callback_data' => 'noop'];
            $keyboard[] = $row;

            sendMessage($chatId, $text, 'Markdown', ['inline_keyboard' => $keyboard]);
        } elseif ($text === '/import') {
            if (isset($message['reply_to_message'])) {
                $replied = $message['reply_to_message'];
                
                if (isset($replied['document'])) {
                    $file = $replied['document'];
                    $fileName = $file['file_name'];
                    $fileSize = $file['file_size'];
                    $requesterId = 0;
                    $requesterName = "imported";
                } elseif (isset($replied['video'])) {
                    $file = $replied['video'];
                    $fileName = $file['file_name'] ?? 'video.mp4';
                    $fileSize = $file['file_size'];
                    $requesterId = 0;
                    $requesterName = "imported";
                } else {
                    sendMessage($ownerId, "âŒ Is message mein koi file nahi hai. Kripya kisi file wale message ka reply karein.");
                    exit;
                }

                $newId = addUploadRecord($fileName, $fileSize, $requesterId, $requesterName);
                if ($newId) {
                    sendMessage($ownerId, "âœ… File database mein add ho gayi! (ID: $newId)\n/uploads mein dekh sakte ho.");
                } else {
                    sendMessage($ownerId, "âŒ Error. Baad mein try karein.");
                }
            } else {
                sendMessage($ownerId, "â„¹ï¸ /import ka use karne ke liye kisi channel se forward ki gayi file wali message ka reply karein.\n\nJaise: kisi channel se file forward karo, uske reply mein /import likho.");
            }
        } else {
            sendMessage($chatId, "âš ï¸ Command samajh nahi aaya. /help dekho.");
        }
        exit;
    }

    // --- Message in request group ---
    if ($chatId == $requestGroupId) {
        if (strpos($text, '/') === 0) exit;

        $from = $message['from'];
        $name = $from['first_name'] . (isset($from['last_name']) ? ' ' . $from['last_name'] : '');
        $username = $from['username'] ?? $name;
        $userId = $from['id'];

        $ownerMsg = "ğŸ“¥ **Naya Request**\n";
        $ownerMsg .= "From: @$username (ID: $userId)\n";
        $ownerMsg .= "Message: $text\n";
        $ownerMsg .= "\n*Is message ka reply file bhej kar channel mein post karein.*";
        sendMessage($ownerId, $ownerMsg, 'Markdown');

        sendMessage($chatId, "âœ… Dhanyavaad $username! Aapki request mil gayi. Jald hi upload karenge ğŸ˜Š");
        exit;
    }

    // --- Owner replying to a request notification with a file ---
    if ($userId == $ownerId && isset($message['reply_to_message'])) {
        $replied = $message['reply_to_message'];
        $repliedText = $replied['text'] ?? '';

        if (preg_match('/ID: (\d+)/', $repliedText, $matches)) {
            $requesterId = $matches[1];
            preg_match('/@(\S+)/', $repliedText, $unameMatches);
            $requesterName = $unameMatches[1] ?? 'Unknown';

            if (isset($message['document'])) {
                $file = $message['document'];
                $fileId = $file['file_id'];
                $fileName = $file['file_name'];
                $fileSize = $file['file_size'];
            } elseif (isset($message['video'])) {
                $file = $message['video'];
                $fileId = $file['file_id'];
                $fileName = $file['file_name'] ?? 'video.mp4';
                $fileSize = $file['file_size'];
            } else {
                sendMessage($ownerId, "âŒ Kripya koi file (document/video) bheje.");
                exit;
            }

            sendChatAction($ownerId, 'typing');

            $progressMsg = sendMessage($ownerId, "â³ Shuru ho raha hai... 0% [â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘â–‘]");
            if ($progressMsg && isset($progressMsg['result']['message_id'])) {
                $progressMessageId = $progressMsg['result']['message_id'];
                simulateProgress($ownerId, $progressMessageId);
            }

            $caption = "ğŸ¬ **$fileName**\nğŸ“¦ Size: " . round($fileSize / 1024 / 1024, 2) . " MB\n\nğŸ“ Requested by: $requesterName\nâœ… Thanks for requesting!";
            $successCount = 0;
            foreach ($channelIds as $channel) {
                $result = apiRequest('sendDocument', [
                    'chat_id' => $channel,
                    'document' => $fileId,
                    'caption' => $caption,
                    'parse_mode' => 'Markdown'
                ]);
                if ($result && isset($result['ok']) && $result['ok']) {
                    $successCount++;
                } else {
                    logMessage("Failed to send to channel $channel");
                }
            }

            $newId = addUploadRecord($fileName, $fileSize, $requesterId, $requesterName);

            sendMessage($ownerId, "âœ… **File posted to $successCount/" . count($channelIds) . " channels!**\nRecord added (ID: $newId). /uploads dekh sakte ho.");

            if ($requesterId) {
                sendMessage($requesterId, "ğŸ‰ Aapki request puri ho gayi! File ab hamare channels mein available hai. Dhanyavaad!");
            }
        } else {
            sendMessage($ownerId, "âŒ Yeh kisi request ka reply nahi lagta. Request notification ke reply mein file bheje.");
        }
        exit;
    }
}

logMessage("No handler matched for this update.");
?>
